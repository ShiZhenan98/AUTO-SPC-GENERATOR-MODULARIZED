# SPC年度计划一键生成工具 - 使用说明

## 快速开始

### 1. 准备工作

确保以下文件在同一目录：
- `SPC模板.xlsx` - SPC模板文件
- `2025年SPC推进计划--VT.xlsx` - SPC推进计划文件（或类似名称）
- `spc_generator/` - 模块化代码目录
- `run_spc_generator.py` - 运行入口脚本

### 2. 运行程序

```bash
python run_spc_generator.py
```

### 3. 选择模式

程序会询问：
```
是否采用参考分布范围? (Y/N, 默认N):
```

- **输入 N 或直接回车**: 使用标准模式（基于公差范围生成数据）
- **输入 Y**: 使用参考分布范围模式（确保数据在指定参考范围内）

### 4. 查看结果

程序会自动：
1. 读取SPC推进计划文件
2. 为每个任务生成SPC文件
3. 按月份组织文件（如果同月有多个文件，会创建文件夹）
4. 询问是否更新原计划文件

---

## 文件结构

### 输入文件

1. **SPC推进计划文件** (如：`2025年SPC推进计划--VT.xlsx`)
   - B列：产品型号（需以NB开头）
   - C列：工序
   - D列：理论值
   - E列：参考分布范围（可选）
   - F列：检测项目
   - G列：分辨率（可选）
   - H列：设备编号
   - I-T列：月份状态（N表示需要生成）
   - U列：目标CPK
   - V列：实际CPK（自动填入）

2. **SPC模板文件** (如：`SPC模板.xlsx`)
   - Excel模板文件
   - 包含SPC图表的完整模板

### 输出文件

1. **生成的SPC文件**
   - 命名格式：`{月份}{产品型号}{工序}{检测项目}[_参考范围]_SPC.xlsx`
   - 例如：`1月NB30381精加工孔径参考范围_SPC.xlsx`

2. **月份文件夹**（如果同月有多个任务）
   - 例如：`1月/` 文件夹包含该月的所有SPC文件

3. **更新后的计划文件**
   - 命名格式：`{原文件名}_已更新.xlsx`
   - 包含实际CPK和目标CPK更新

---

## 功能特点

### 标准模式

- 基于公差范围生成数据
- 允许中心在±0.2σ内浮动
- 允许子组平均值5%波动
- 确保满足8条判异准则
- 目标CPK在±0.03范围内

### 参考分布范围模式

- 确保125个原始数据中至少100个在参考范围内
- 确保25个Xbar全部在参考范围内
- 每个子组至少4/5个点在参考范围内
- 其他要求与标准模式相同

### 支持的公差格式（25+种）

1. 特殊值：OK、/、符合
2. 对称公差：φ3.5±0.1、120°±3°
3. 不对称公差：27.4（-0.05/-0.1）
4. 范围格式：47.322-47.331
5. 形位公差：≤Φ0.04、Φ0.04
6. 粗糙度：Ra0.8、≤Pt3.2
7. 角度公差：120°±3°
8. 倒角公差：C0.3±0.2、C0.3max
9. 圆角公差：R1.5±0.3
10. 最大值/最小值：max50、min25
11. 基值-下限-上限格式
12. 等等...

---

## 常见问题

### Q1: 找不到SPC推进计划文件

**解决方案**：
- 确保文件名包含"SPC推进计划"或"推进计划"关键词
- 确保文件扩展名为`.xlsx`
- 确保文件在工作目录中

### Q2: 数据生成失败

**可能原因**：
1. 目标CPK不合理
2. 参考分布范围超差
3. 公差解析失败

**解决方案**：
- 检查目标CPK是否在合理范围内
- 检查参考分布范围是否在公差范围内
- 检查理论值格式是否正确

### Q3: CPK值与Excel不一致

**说明**：
- 程序使用组内标准差方法（Rbar/d2）计算CPK
- 与Excel模板的计算方法一致
- 如有差异，请检查数据或公差设置

### Q4: 生成的文件太多，如何管理？

**解决方案**：
- 程序会自动按月份组织文件
- 同月有多个文件时会自动创建月份文件夹
- 可以手动移动文件到其他目录

---

## 技术支持

如有问题，请检查：
1. Python版本（推荐3.7+）
2. 依赖包是否已安装
3. 文件路径和权限
4. Excel文件格式是否正确

---

## 版本信息

- **当前版本**: V3.4（模块化版本）
- **原版本**: V3.3.1
- **重构日期**: 2026年
- **模块数量**: 30+
- **代码行数**: ~3,200行

---

## 更新日志

### V3.4（模块化版本）
- ✅ 完全模块化重构
- ✅ 从1个2657行文件拆分为30+个模块
- ✅ 添加完整的单元测试支持
- ✅ 提高代码可维护性和可扩展性
- ✅ 保持功能完全兼容V3.3.1
